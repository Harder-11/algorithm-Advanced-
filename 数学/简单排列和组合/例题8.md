# 例题8分析

新年树上有$n$层灯,第$i$层有$l_i$盏灯,需要满足
1.每层中相邻两盏灯的颜色不同
2.相邻两层使用的颜色集合不同
有$m$种颜色的灯,求装饰的方案数,对$p$取模
$1\leq n,m \leq 1e6,2\leq p \leq 1e9,1 \leq l_i \leq 5000,\sum_{i=1}^nl_i\leq1e7$

首先我们考虑同一层,我们假设从上到下每一层为$l1,l2,l3...ln$

我们使用$dp$来解决同一层的情况

假设$f[l][k]$表示本层有$l$盏灯,用了$k$种颜色的方案数

显然转移方程就是
$$
f[l][k] = f[l-1][k-1]+(k-1)*f[l-1][k]
$$
$f[l][k]$可以直接从$f[l-1][k-1]$转移过来因为剩下的灯必须选剩下的那种颜色,也可以从$f[l-1][k]$转移得到,但是不能和前面的灯颜色一样,所以只能选$k-1$种颜色

然后我们考虑上下层的关系,假设我们没有任何限制条件,对于$l_1$层的方案数$s_1$为
$$
s_1 = f[l_1][1]*A_{m}^1+f[l_1][2]*A_{m}^2+...+f[l_1][l_1]*A_{m}^{l_1}
$$
因为之前求每一层转移方程的时候并没有考虑颜色的种类,这里就要添上$A_{m}^i$

对于上下层的关系,我们也用动态规划求

设$g[i][j]$表示当前是第$i$层,用了$j$种颜色的方案数

转移枚举上一层几种颜色,不同直接随便选颜色组合,相同则需要扣减一样的情况
$$
k\neq j:g[i][j] = g[i-1][k]*f[l_i][j]*\binom{m}{j}*j!\\
k=j:g[i][j]=g[i-1][k]*f[l_i][j]*(\binom{m}{j}-1)*j!
$$
我们计$h_i = \sum_{j=1}^{l_i}g[i][j]$,则有
$$
g[i][j]=f[l_i][j]*(h_i*\binom{m}{j}-g[i-1][j])*j!
$$








