# 容斥

## 两个子集情况

(两个子集)定理:设$S$是一个有限集,$A$和$B$是$S$的两个子集,则有
$$
|S - A\cup B| = |S| - |A| - |B| + |A\cap B|
$$
$例题1.$比如求正整数$1$到$n$中,既不是$2$的倍数也不是$3$的倍数的数量

正难则反,那么我们令
$$
S = \{1,2,3...n \}\\
A = \{x\in S|\ 2|x\}\\
B = \{x\in S|\ 3|x\}
$$
那么答案就是$|S - A\cup B| = |S| - |A| - |B| + |A\cap B|$

也就是$n - \lfloor n / 2 \rfloor - \lfloor n / 3 \rfloor + \lfloor n / 6 \rfloor$

$例题2.$求由$n$个元素$1,2,3....n$作成的全排列,满足$1$与$2$不相邻,$3$与$4$也不相邻的方案数
$$
S = \{所有全排列\}\\
A=\{p\in S|\ 排列p中1与2相邻\}\\
B=\{p\in S|\ 排列p中3与4相邻\}
$$
那么此时我们要求的方案数也是$|S|-|A|-|B|+|A\cap B|$

也就是$n! - (n-1)!*2 - (n-1)!*2+(n-2)!*2^2$



## 三个子集情况

(三个子集)定理:假设$S$是一个有限集$A,B,C$是$S$的三个子集,则:
$$

$$

$$
|S-A\cup B\cup C|\\ 
= |S| - |A| - |B| - |C| + |A\cap B| + |A\cap C| + |B\cap C| - |A\cap B\cap C|
$$

$例题1.$把$n$件不一样的物品放到$3$个盒子里,满足每个盒子至少有一个物品的方案数

我们假设
$$
S = \{n件物品放到3个盒子的方案组成的方案集合\}\\
A = \{第一个盒子没有物品的方案的集合\}\\
B = \{第二个盒子没有物品的方案的集合\}\\
C = \{第三个盒子没有物品的方案的集合\}
$$
那么最终答案就是$|S|-|A|-|B|-|C|+|A\cap B|+|A\cap C|+|B\cap C|-|A\cap B\cap C|$

代入数字也就是
$$
3^n-3 * 2^n+3
$$



## N个子集情况

定理(容斥原理):设$S$是一个有限集,$A_1,A_2,...,A_n$是$S$的子集,则有:
$$
|S-\cup_{i=1}^nA_i| = \sum_{i=0}^n(-1)^i\sum_{1\leq j_1< j_2<...<j_i\leq n}|\cap_{k=1}^iA_{j_k}|
$$


$例题1.$$m$件不同的物品,分给$n$个人,要求每个人至少要分得一件物品,求不同的分配方案数

我们假设:
$$
S = \{m件物品分配给n个人的方案的集合\}\\
A_1 = \{第一个人没有物品\}\\
A_2 = \{第二个人没有物品\}\\
....\\
A_n = \{第n个人没有物品\}
$$
那么答案就是
$$
|S-\cup_{i=1}^nA_i| = \sum_{i=0}^n(-1)^i\sum_{1\leq j_1< j_2<...<j_i\leq n}|\cap_{k=1}^iA_{j_k}|
$$



对于式子$|\cap_{k=1}^iA_{j_k}|$就是第$j_1,j_2...j_i$个人都没有物品那么就是$m$件物品分配给另外的$n-i$个人中,也就是$(n-i)^m$

那么式子可以化简为
$$
\sum_{i=0}^n(-1)^i\binom{n}{i}(n-i)^m
$$


$例题2.$有$2n$个元素$a_1,a_2,...,a_n$和$b_1,b_2,...b_n$,求有多少个它们的全排列,满足任意的$1\leq i \leq n$,$a_i$和$b_i$都不相邻

我们设
$$
S = \{2n个元素的全排列\}\\
A_i = \{a_i和b_i是相邻的\}(1 \leq i \leq n)
$$
那么根据容斥原理也是$|S - \cup_{i=1}^nA_i|$

此时对于式子$|\cap_{k=1}^i A_{j_k}|$的就是有$i$对$a_j$和$b_j$是相邻的,这样捆绑起来就是

$(2n-i)! * 2^i$

所以答案就是
$$
\sum_{i=0}^n(-1)^i\binom{n}{i}*(2n-i)! *2^i
$$
$例题3.$求不定方程$x_1+x_2+...+x_k = n$的解的数量,其中$x_i$为整数,且$l_i\leq x_i \leq r_i(1\leq i \leq k)$

我们令
$$
S = \{x_1 + x_2 + x_3+...+x_k=n的所有满足x_i \geq l_i的解\}\\
A_i = \{x_1+x_2+...+x_k=n的满足x_i \geq r_i+1的解\}
$$
所以答案就是$|S - \cup_{i=1}^kA_i|=|S| - |\cup_{i=1}^kA_i|$ 

现在我们先计算$|S|$

由于
$$
S:\sum_{i=1}^kx_i = n(x_i \geq l_i)
$$
我们做线性变换$y_i = x_i - l_i+1(y_i\geq 1)$

则原方程变为
$$
\sum_{i=1}^k(y_i+l_i-1) = n\Rightarrow\sum_{i=1}^ky_i=n-\sum_{i=1}^kl_i+k
$$
利用隔板法可知此时有$n - \sum_{i=1}^kl_i + k - 1$个空,一共有$k-1$个板子,则此时方程的解的数目为
$$
|S| = \binom{n - \sum_{i=1}^kl_i + k - 1}{k - 1}
$$
然后我们求$|\cup_{i=1}^kA_i|$

和求$|S|$同理,我们仍然用线性变化可以轻松求到答案为
$$
\binom{n - \sum_{i=1}^kl_i-\sum_{p=1}^m(r_{j_p}+1-l_{j_p})+k-1}{k-1}
$$
最后答案化简后得到
$$
\sum_{m=0}^k(-1)^m\sum_{1\leq j_1 < .. < j_m \leq k}\binom{n - \sum_{i=1}^kl_i-\sum_{p=1}^m(r_{j_p}+1-l_{j_p})+k-1}{k-1}
$$
$例题4.$$p$是$1,2,...,n$的一个排序,满足$\forall 1 \leq i \leq n,p_i \neq i$,求满足的排列有多少个?

我们设
$$
S = \{1,2,...,n的全排列\}\\
A_i = \{p_i = i的排列\}(1 \leq i \leq n)
$$
答案就是$|S-\cup_{i=1}^nA_i|$

目前要求的就是$p$排列里面有$i$个满足$p_i = i$的排列的个数,那么此时剩下的$n-i$个就随便填,也就是$(n-i)!$

所以答案就是
$$
\sum_{i=0}^n(-1)^i\binom{n}{i}(n-i)!
$$




